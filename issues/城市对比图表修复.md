# 城市对比图表修复

## 问题描述
城市对比功能中的图表无法正常显示，原因是后端API返回的数据格式与前端期望的格式不一致。

## 解决方案
添加数据转换层，将API返回的实际数据格式转换为前端期望的格式，并添加新的图表组件，展示城市公司规模和教育程度的分布情况。

## 修改内容

1. 在 `src/api/types.ts` 中添加新的接口定义：
   - 添加 `ActualCityComparisonData` 接口，匹配实际API返回的数据结构

2. 在 `src/stores/city.ts` 中：
   - 添加 `rawComparisonData` 状态变量，用于存储原始API返回数据
   - 修改 `fetchCityComparison` 方法，添加数据转换逻辑
   - 添加 `cityCompanySizeOptions` 和 `cityEducationOptions` 计算属性，用于新增图表

3. 在 `src/views/city-analysis/index.vue` 中：
   - 添加新的图表组件，展示城市公司规模和教育程度的分布情况

## 实际API返回的数据格式
```json
{
  "code": 200,
  "data": {
    "city_company_size": {
      "北海": {
        "150-500": 2,
        "50-150": 1,
        "500-1000": 1
      },
      "塔城": {
        "1000-5000": 1,
        "50-150": 1
      },
      "沧州": {
        "150-500": 1,
        "50-150": 2,
        "5000-10000": 1
      }
    },
    "city_education": {
      "北海": {
        "大专": 1,
        "本科": 3
      },
      "塔城": {
        "在校生": 1,
        "本科": 1
      },
      "沧州": {
        "大专": 3,
        "本科": 1
      }
    },
    "city_salary": {
      "北海": 5937.5,
      "塔城": 4875,
      "沧州": 5875
    }
  },
  "message": "获取城市对比数据成功"
}
```

## 转换后的数据格式
```typescript
interface CityComparisonData {
  cities: string[];
  counts: number[];
  percentages: number[];
  ranking: number[];
  comparison: Record<string, number>;
  salary_comparison: Record<string, {
    avg: number;
    min: number;
    max: number;
  }>;
}
```

## 后续优化（2023-06-05）

在进一步检查后，发现以下问题并进行了修复：

1. **百分比计算问题**：
   - 原来的百分比计算使用全局职位总数作为分母，导致百分比不准确
   - 修改为使用当前选中城市的职位总和作为分母，使百分比计算更加合理

2. **雷达图显示优化**：
   - 增强雷达图的提示信息，显示更详细的数据
   - 调整雷达图的指示器配置，使数据展示更加合理
   - 为不同城市设置不同颜色，提高可读性
   - 百分比最大值固定为100%，避免数据比例失调

3. **薪资数据说明**：
   - 明确注明最低和最高薪资是基于平均薪资的估算值，不是实际值
   - 在雷达图中添加单位标识，使数据更加清晰

## 数据真实性优化（2023-06-05）

根据用户反馈，数据必须百分百真实，不能使用估算值。因此进行了以下修改：

1. **移除估算数据**：
   - 移除了薪资数据中的最低和最高薪资估算值
   - 只保留后端API提供的实际平均薪资数据

2. **雷达图维度调整**：
   - 移除了最低和最高薪资维度
   - 只保留职位数量、平均薪资和占比三个维度
   - 调整了雷达图的提示信息，只显示实际数据

3. **后续建议**：
   - 建议与后端开发人员沟通，提供更完整的薪资数据API，包括最低和最高薪资
   - 如果后端能提供更多维度的数据，可以进一步丰富图表展示

## 后端API升级与前端适配（2023-06-06）

后端开发人员已经实现了新的API，提供更完整的数据。新的API返回数据格式如下：

```json
{
  "code": 200,
  "data": {
    "city_company_size": {
      "上海": {
        "1000-5000": 299,
        "150-500": 520,
        "50-150": 568,
        "500-1000": 220,
        "5000-10000": 64,
        "<50": 234,
        ">10000": 68
      },
      "北京": {
        "1000-5000": 216,
        "150-500": 244,
        "50-150": 258,
        "500-1000": 148,
        "5000-10000": 44,
        "<50": 78,
        ">10000": 51
      },
      "广州": {
        "1000-5000": 250,
        "150-500": 336,
        "50-150": 352,
        "500-1000": 156,
        "5000-10000": 28,
        "<50": 131,
        ">10000": 31
      }
    },
    "city_education": {
      "上海": {
        "博士": 1,
        "在校生": 12,
        "大专": 1065,
        "本科": 885,
        "硕士": 10
      },
      "北京": {
        "博士": 1,
        "在校生": 2,
        "大专": 477,
        "本科": 556,
        "硕士": 3
      },
      "广州": {
        "在校生": 5,
        "大专": 792,
        "本科": 486,
        "硕士": 1
      }
    },
    "city_job_counts": {
      "上海": 1973,
      "北京": 1039,
      "广州": 1284
    },
    "city_salary": {
      "上海": {
        "avg": 11861.91,
        "max": 190000,
        "min": 1750
      },
      "北京": {
        "avg": 12026.17,
        "max": 45000,
        "min": 1041.67
      },
      "广州": {
        "avg": 9907.2,
        "max": 104166.67,
        "min": 1850
      }
    }
  },
  "message": "获取城市对比数据成功"
}
```

针对新的API，我们进行了以下修改：

1. **更新接口定义**：
   - 修改 `ActualCityComparisonData` 接口，匹配新的数据结构
   - 添加 `city_job_counts` 字段，直接使用后端提供的职位总数
   - 修改 `city_salary` 字段，使用后端提供的真实薪资数据

2. **优化数据处理**：
   - 修改 `fetchCityComparison` 方法，直接使用后端返回的职位总数和薪资数据
   - 不再需要从公司规模数据中计算职位总数
   - 不再需要估算最低和最高薪资

3. **雷达图维度恢复**：
   - 恢复最低和最高薪资维度，使用后端提供的真实数据
   - 调整雷达图的指示器配置，展示更全面的数据对比

这些修改使得城市对比图表的数据更加准确和全面，同时也提高了代码的可维护性 